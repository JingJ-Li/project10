---
title: "st542_project10"
author: "Jingjing Li"
date: "2023-06-15"
output: html_document
---

```{r}
library(tidyverse)
```

```{r}
# var_defa <- readxl::read_excel ("data/Variable_def.xlsx",sheet="Definitions")
# var_defb <- readxl::read_excel("data/Variable_def.xlsx",sheet="VariableParkingLot_not_in_data ")
# var_def2a <- readxl::read_excel ("data/Variable_def2.xlsx",sheet="Definitions")
# var_def2b <- readxl::read_excel("data/Variable_def2.xlsx",sheet="VariableParkingLot_not_in_data ")
rain<- readxl::read_excel("data/Rainfall_Variation_2.xls")
survey_2019_pond_v2 <- readxl::read_excel("data/survey_2019_ponds_v2.xlsx")
ariq_drain<- readxl::read_excel("data/ARIQ_drainage_areas.xlsx")
rolim_drain<- readxl::read_excel("data/Rolim_drainage_areas.xlsx")
opo_drain <-readxl::read_excel("data/OPO_drainage_areas.xlsx")
# head(var_defa)
# head(var_defb)
# head(var_def2a)
# head(var_def2b)
head(rain)
head(ariq_drain)
head(rolim_drain)
head(opo_drain)
```
```{r}
library(haven)
survey<- read_dta("data/survey_panel96_19_noID_surveyyears.dta") 
dim(survey)
```

# Data Combination

First to explore the data. Seems to be already limited to only 2019

```{r}
cols <- colnames(survey)
survey_clean <- survey %>% filter(startdate != "") #Removing blank survey start dates
min(survey_clean$startdate)
min(survey_clean$enddate)
dim(survey_clean) # When removing the blank survey dates - only 1342 remain. Is this right?
```

Now to join to the drainage data. I'm excluding rainfall data since there are quite
a few missing rows, and to Jingjing's point - there could be multicollinearity.

```{r}
head(survey_clean$lotid_qualtrics)
head(rain$lotidtot)
head(survey_2019_pond_v2$lotidtot)
head(ariq_drain$Qual_lotid) # I think this has an extra 0
head(rolim_drain$lotid) # I think this has an extra 0
head(opo_drain$lotidtot)

# Code if you want rainfall data
#survey_rain <- merge(survey, rain, by.x = "lotid_qualtrics", by.y = "lotidtot")
#dim(survey_rain)
# Joining to drainage data from the Ariq region
ariq_clean <- ariq_drain %>% select(c("Qual_lotid", "Drainage_AreaKM", "LargArea")) %>%
  rename("drainage_area_km" = "Drainage_AreaKM", "Size" = "LargArea")
ariq_clean %>% mutate (region="ariq") -> ariq_clean
survey_ariq_drain <- merge(survey_clean, ariq_clean, by.x = "lotid_qualtrics", by.y = "Qual_lotid")
dim(survey_ariq_drain)
dim(ariq_drain) # some duplication - come back to investigate

# Joining to drainage data from Rolim region
rolim_drain_clean <- rolim_drain %>% mutate(lotid_qualtrics = as.double(ifelse(nchar(lotid) == 7 & substr(lotid, start = 7, stop = 7) == 0, substr(lotid, start = 0, stop = 6), ifelse(nchar(lotid) == 6 & substr(lotid, start = 6, stop = 6) == 0, substr(lotid, start = 0, stop = 5), lotid)))) %>%
  select(c("lotid_qualtrics", "RO_area_km", "Size")) %>%
  rename("drainage_area_km" = "RO_area_km")
rolim_drain_clean %>% mutate (region="rolim") -> rolim_drain_clean
survey_rolim_drain <- merge(survey_clean, rolim_drain_clean, by.x = "lotid_qualtrics", by.y = "lotid_qualtrics")
dim(survey_rolim_drain)

# Joining to drainage data from Opo region
opo_drain_clean <- opo_drain %>% rename("drainage_area_km" = "OPO_area_km")
opo_drain_clean %>% mutate (region="opo") -> opo_drain_clean
survey_opo_drain <- merge(survey_clean, opo_drain_clean, by.x = "lotid_qualtrics", by.y = "lotidtot")
dim(survey_opo_drain)

# Joining into one dataset
survey_clean_drainage <- rbind(survey_opo_drain, rbind(survey_ariq_drain, survey_rolim_drain))
dim(survey_clean_drainage)

# Checking for duplicates - asked Mariana about these and waiting for a response
survey_duplicates <- survey_clean_drainage %>% 
  group_by(lotid_qualtrics) %>% 
  filter(n()>1)

# Joining pond data - doesn't have full rows
pond_clean <- survey_2019_pond_v2 %>% mutate(lotid_qualtrics = as.double(ifelse(nchar(lotidtot) == 7 & substr(lotidtot, start = 7, stop = 7) == 0, substr(lotidtot, start = 0, stop = 6), ifelse(nchar(lotidtot) == 6 & substr(lotidtot, start = 6, stop = 6) == 0, substr(lotidtot, start = 0, stop = 5), lotidtot)))) %>%
  select(c("lotid_qualtrics", fishtanks,reservoir, reservoir_have, lotsize_GIS_ponds))
survey_gis <- merge(survey_clean_drainage, pond_clean, by.x = "lotid_qualtrics", by.y = "lotid_qualtrics", all.x = TRUE)
dim(survey_gis)


```
NOTE: There are duplicates in this combined data - waiting for Mariana to say what to do with them.

Start EDA with some individual variable histograms.

```{r}
g <- ggplot(data = survey_gis, aes(x = drainage_area_km))
g + geom_histogram() + labs(title = "Histogram of Drainage Area")

g <- ggplot(data = survey_gis, aes(x = rainfall))
g + geom_histogram() + labs(title = "Boxplot of Rainfall")

g <- ggplot(data = survey_gis, aes(x = SPI_year))
g + geom_histogram() + labs(title = "Histogram of Average Yearly SPI")

g <- ggplot(data = survey_gis, aes(x = vechval))
g + geom_histogram() + labs(title = "Histogram of Vehicle Value")

g <- ggplot(data = survey_gis, aes(x = family))
g + geom_histogram() + labs(title = "Histogram of Family Size")

g <- ggplot(data = survey_gis, aes(x = lotsize_gis))
g + geom_histogram() + labs(title = "Histogram of Lot Size")

```
Next, we can look at some box plots
```{r}
g <- ggplot(data = survey_gis, aes(x = drainage_area_km))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area")

g <- ggplot(data = survey_gis, aes(x = rainfall))
g + geom_boxplot() + labs(title = "Boxplot of Rainfall")

g <- ggplot(data = survey_gis, aes(x = SPI_year))
g + geom_boxplot() + labs(title = "Boxplot of Average Yearly SPI")

g <- ggplot(data = survey_gis, aes(x = SPI_dry))
g + geom_boxplot() + labs(title = "Boxplot of Average in Peak Dry Season")

g <- ggplot(data = survey_gis, aes(x = SPI_wet))
g + geom_boxplot() + labs(title = "Boxplot of Average in Peak Wet Season")

g <- ggplot(data = survey_gis, aes(x = vechval))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value")

g <- ggplot(data = survey_gis, aes(x = family))
g + geom_boxplot() + labs(title = "Boxplot of Family Size")

g <- ggplot(data = survey_gis, aes(x = lotsize_gis))
g + geom_boxplot() + labs(title = "Boxplot of Lot Size")

g <- ggplot(data = survey_gis, aes(x = eduhh_most))
g + geom_boxplot() + 
  labs(title = "Boxplot of Level of Education of Most Educated Household Member")

```

Let's look at barplots for a few categorical variables


```{r}
ggplot(survey_gis, aes(x=irrigation)) + geom_bar() + 
  labs(title = "Barplot of Number of Irrigation Systems")

ggplot(survey_gis, aes(x=well)) + geom_bar() + 
  labs(title = "Barplot of Number of Wells")


```

Let's look at boxplots of drainage area and vehicle value (wealth) grouped by cattle.

```{r}
g <- ggplot(data = survey_gis, aes(x = drainage_area_km, y = as.factor(havecattle)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by Cattle") +
  ylab("Cattle")

g <- ggplot(data = survey_gis, aes(x = vechval, y = as.factor(havecattle)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by Cattle") +
  ylab("Cattle")

```

Next lets look at pair plots

```{r}
pairs_subset <- survey_gis %>% select(c(vechval, family, lotsize_gis, drainage_area_km, SPI_year, havecattle, rainfall))
pairs(pairs_subset)
```
EDA with tables

Comparison of rainfall of three regions
```{r}
 hist(survey_gis$rainfall[survey_gis$region=="opo"]) 
 hist(survey_gis$rainfall[survey_gis$region=="rolim"]) 
 hist(survey_gis$rainfall[survey_gis$region=="ariq"]) 
 hist(survey_gis$rainfall)
```
```{r}
g <- ggplot(data = survey_gis, aes(x = rainfall, y = cattleherd))
g + geom_point() + labs(title = " relationship between rainfall and cattleherd ") +
  ylab("Cattleherd")
points( survey_gis$rainfall,survey_gis$cattleherd)
```

