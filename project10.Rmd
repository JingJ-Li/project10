---
title: "st542_project10"
author: "Jingjing Li"
date: "2023-06-15"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(tidyverse)
library(ggplot2)
library(haven)
library(tidyverse)
library(ggplot2)
library(haven)
library(psych)
```

### Exploring the merged data

```{r}
survey_merged <- read_dta("../data/merged_survey_panel96_19_noID.dta") 
dim(survey_merged)
survey_merged_clean <- survey_merged %>% 
  filter(!is.na(lotid_qualtrics))
# Removing duplicates for modelling - forgot to ask Mariana which should be kept, so just keeping first for now
# Also open to just dropping all duplicated lotids - there's only 42
survey_final <- survey_merged_clean %>% distinct(lotid_qualtrics, .keep_all = TRUE)
```

Now to check for nulls in columns:
```{r}
missing_vals <- survey_final %>% summarise_all(~sum(is.na(.)))
t(missing_vals)
```
There seem to be a lot of columns missing 1026 values, which puts the numbers back to what we saw in the original data. Clearly there is a lot of missing data across all areas, so I don't think we should drop all rows missing data. 

## Feature Engineering

### Creating One Drainage Area Column 
I will create one drainage area column, and then will drop all rows that don't have drainage area. Not sure if this is the best approach but this data is so messy!

```{r}
# There are two lots that have areas in each region - will drop them
duplicate_regions <- survey_final %>% filter(!is.na(OPO_area_km) & !is.na(RO_area_km)) %>% select(lotid_qualtrics)
survey_final <- survey_final %>% filter(!(lotid_qualtrics %in% duplicate_regions$lotid_qualtrics))
survey_final <- survey_final %>% mutate(drainage_area_km = ifelse(!is.na(Drainage_AreaKM_Ari), Drainage_AreaKM_Ari, ifelse(!is.na(OPO_area_km), OPO_area_km, ifelse(!is.na(RO_area_km), RO_area_km, NA))),
                                        region = ifelse(studycode == 1, "Ariquemes",
                                                        ifelse(studycode == 2, "Ouro Preto do Oeste", ifelse(studycode == 3, "Rolim de Moura", NA)))) %>%
  select(-c(Drainage_AreaKM_Ari, RO_area_km, OPO_area_km))
```


### Creating Individual Adaptation Method Booleans
First, I need to create the indivdual adaptation method booleans i.e. `cattle_management` if the farmer employed any cattle management strategy. Then I can combine these to make a general adaptation method boolean.

```{r}
survey_final <- survey_final %>% mutate(cattle_management = case_when(feed_cattle == 1  | soil_analysis == 1 | cattleinputs_breed == 1 | semiconfine == 1 | sellcattle_droughtexp == 1 ~ 1, .default = 0),
                                        pasture_management = case_when(irrigation_pas == 1 | pasture_productivity == 1 | fert_pasture ==1 | pest_pasture == 1 | fallow == 1 ~ 1, .default = 0),
                                        forest_conservation = case_when(forest_rec == 1 | keep_veg == 1 ~ 1, .default = 0),
                                        water_management = case_when(waterstructure == 1 | well_have == 1 | dam_have == 1 | reservoir_have == 1 ~ 1, .default = 0)) # Chose to use case when to account for NA - need to ask Mariana how these should be treated

# Looking at distributions
g <- ggplot(data = survey_final, aes(x = cattle_management))
g + geom_bar() + labs(title = "Bar Plot of Cattle Management")

g <- ggplot(data = survey_final, aes(x = pasture_management))
g + geom_bar() + labs(title = "Bar Plot of Pasture Management")

g <- ggplot(data = survey_final, aes(x = forest_conservation))
g + geom_bar() + labs(title = "Bar Plot of Forest Conservation")

g <- ggplot(data = survey_final, aes(x = water_management))
g + geom_bar() + labs(title = "Bar Plot of Water Management")

```

### Creating General Adaptation Method Boolean
Now that the indivdual adaptation measures have been created, I will create a general adaptation method boolean

```{r}
survey_final <- survey_final %>% mutate(any_adaptation = ifelse(cattle_management == 1 | pasture_management == 1 | forest_conservation == 1 | water_management == 1,1,0))

# Looking at the distribution
g <- ggplot(data = survey_final, aes(x = any_adaptation))
g + geom_bar() + labs(title = "Bar Plot of Any Adaptation")
```
Not a fully even data set, but better balanced than I predicted it would be. I don't
think rebalancing is needed for the final analysis.

Now let's see if we remove farmers who don't have GIS information
```{r}
survey_final_gis <- survey_final %>% filter(!is.na(drainage_area_km))

# Looking at the distribution
g <- ggplot(data = survey_final_gis, aes(x = any_adaptation))
g + geom_bar() + labs(title = "Bar Plot of Any Adaptation")
```
Now it is very imbalanced. Not as horrible as it could be - but could affect the outputs of the model. Is SPI still missing for these?

```{r}
missing_vals_gis <- survey_final_gis %>% summarise_all(~sum(is.na(.)))
t(missing_vals_gis)
```
Now only for 140 of them, who are also missing region. Let's drop those and see:
```{r}
survey_final_gis_clean <- survey_final_gis %>% filter(!is.na(SPImin_year))

# Looking at the distribution
g <- ggplot(data = survey_final_gis_clean, aes(x = any_adaptation))
g + geom_bar() + labs(title = "Bar Plot of Any Adaptation")

# Looking at the distribution for the individual variables
g <- ggplot(data = survey_final_gis_clean, aes(x = cattle_management))
g + geom_bar() + labs(title = "Bar Plot of Cattle Management")

g <- ggplot(data = survey_final_gis_clean, aes(x = pasture_management))
g + geom_bar() + labs(title = "Bar Plot of Pasture Management")

g <- ggplot(data = survey_final_gis_clean, aes(x = forest_conservation))
g + geom_bar() + labs(title = "Bar Plot of Forest Conservation")

g <- ggplot(data = survey_final_gis_clean, aes(x = water_management))
g + geom_bar() + labs(title = "Bar Plot of Water Management")
```
And everyone did some sort of adaptation method. Great - this means if we drop all missing water data, we can't look at a relationship between general adaptation and results. If we include rows that are missing SPI and just use drainage area, there is still a model that can be run.

## Exploratory Data Analysis

NOTE 2: Plots are currently using the data as-is while waiting for a response on the duplicate values

Start EDA with some individual variable histograms.

```{r}
g <- ggplot(data = survey_final_gis, aes(x = drainage_area_km))
g + geom_histogram() + labs(title = "Histogram of Drainage Area")

g <- ggplot(data = survey_final_gis, aes(x = rainfall))
g + geom_histogram() + labs(title = "Boxplot of Rainfall")

g <- ggplot(data = survey_final_gis, aes(x = SPI_year))
g + geom_histogram() + labs(title = "Histogram of Average Yearly SPI")

g <- ggplot(data = survey_final_gis, aes(x = vechval))
g + geom_histogram() + labs(title = "Histogram of Vehicle Value")

g <- ggplot(data = survey_final_gis, aes(x = family))
g + geom_histogram() + labs(title = "Histogram of Family Size")

g <- ggplot(data = survey_final_gis, aes(x = lotsize_gis))
g + geom_histogram() + labs(title = "Histogram of Lot Size")

```
Next, we can look at some box plots
```{r}
g <- ggplot(data = survey_final_gis, aes(x = drainage_area_km))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area")

g <- ggplot(data = survey_final_gis, aes(x = rainfall))
g + geom_boxplot() + labs(title = "Boxplot of Rainfall")

g <- ggplot(data = survey_final_gis, aes(x = SPI_year))
g + geom_boxplot() + labs(title = "Boxplot of Average Yearly SPI")

g <- ggplot(data = survey_final_gis, aes(x = SPI_dry))
g + geom_boxplot() + labs(title = "Boxplot of Average in Peak Dry Season")

g <- ggplot(data = survey_final_gis, aes(x = SPI_wet))
g + geom_boxplot() + labs(title = "Boxplot of Average in Peak Wet Season")

g <- ggplot(data = survey_final_gis, aes(x = vechval))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value")

g <- ggplot(data = survey_final_gis, aes(x = family))
g + geom_boxplot() + labs(title = "Boxplot of Family Size")

g <- ggplot(data = survey_final_gis, aes(x = lotsize_gis))
g + geom_boxplot() + labs(title = "Boxplot of Lot Size")

g <- ggplot(data = survey_final_gis, aes(x = eduhh_most))
g + geom_boxplot() + 
  labs(title = "Boxplot of Level of Education of Most Educated Household Member")

```

Let's look at barplots for a few categorical variables


```{r}
ggplot(survey_final_gis, aes(x=irrigation)) + geom_bar() + 
  labs(title = "Barplot of Number of Irrigation Systems")
ggplot(survey_final_gis, aes(x=well)) + geom_bar() + 
  labs(title = "Barplot of Number of Wells")


```

Let's look at boxplots of drainage area and vehicle value (wealth) grouped by cattle.

```{r}
g <- ggplot(data = survey_final_gis, aes(x = drainage_area_km, y = as.factor(havecattle)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by Cattle") +
  ylab("Cattle")

g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(havecattle)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by Cattle") +
  ylab("Cattle")

```

Next lets look at pair plots

```{r}
pairs_subset <- survey_final_gis %>% select(c(vechval, family, drainage_area_km, SPImax_year, havecattle, rainfall, lotprice))
pairs(pairs_subset)

```
```{r}
describe(survey_gis[c('drainage_area_km', 'rainfall', 'rainfall_wet', 'rainfall_dry', 'SPI_wet', 'SPI_dry', 'incbeef',  'vechval', 'milkincwet','milkincdry','lotprice', 'family')], fast=TRUE) # "I don't know why "milkincome is missed here.
```

## boxplot supplement

### Effect of region on drainage area, rainfall and vechval  
```{r}
g <- ggplot(data = survey_final_gis, aes(x = log(drainage_area_km), y = as.factor(region)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by region") +
  ylab("region")
g <- ggplot(data = survey_final_gis, aes(x = rainfall, y = as.factor(region)))
g + geom_boxplot() + labs(title = "Boxplot of rainfall grouped by region") +
  ylab("region")
g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(region)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by region") +
  ylab("region")
```
### Effect of cattle_management on drainage area, rainfall and vechval  
```{r}
g <- ggplot(data = survey_final_gis, aes(x = log(drainage_area_km), y = as.factor(cattle_management)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by Cattle_management") +
  ylab("cattle_management")

g <- ggplot(data = survey_final_gis, aes(x = rainfall, y = as.factor(cattle_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by Cattle") +
  ylab("cattle_management")

g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(cattle_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by Cattle") +
  ylab("cattle_management")

```
### Effect of pasture_management  on drainage area, rainfall and vechval  
```{r}
g <- ggplot(data = survey_final_gis, aes(x = log(drainage_area_km), y = as.factor(pasture_management)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by pasture_management") +
  ylab("pasture_management")

g <- ggplot(data = survey_final_gis, aes(x = rainfall, y = as.factor(pasture_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by pasture_management") +
  ylab("pasture_management")

g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(pasture_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by pasture_management") +
  ylab("pasture_management")
```

### Effect of forest_conservation on drainage area, rainfall and vechval  
```{r}
g <- ggplot(data = survey_final_gis, aes(x = log(drainage_area_km), y = as.factor(forest_conservation)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by forest_conservation") +
  ylab("forest_conservation")

g <- ggplot(data = survey_final_gis, aes(x = rainfall, y = as.factor(forest_conservation)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by forest_conservation") +
  ylab("forest_conservation")

g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(forest_conservation)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by forest_conservation") +
  ylab("forest_conservation")
```

### Effect of water_management on drainage area, rainfall and vechval  
```{r}
g <- ggplot(data = survey_final_gis, aes(x = log(drainage_area_km), y = as.factor(water_management)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by water_management") +
  ylab("water_management")

g <- ggplot(data = survey_final_gis, aes(x = rainfall, y = as.factor(water_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by water_management") +
  ylab("water_management")

g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(water_management)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by water_management") +
  ylab("water_management")
```
### Effect of any_adaptation on drainage area, rainfall and vechval 

```{r}
g <- ggplot(data = survey_final_gis_clean, aes(x = log(drainage_area_km), y = as.factor(any_adaptation)))
g + geom_boxplot() + labs(title = "Boxplot of Drainage Area grouped by any_adaptation") +
  ylab("any_adaptation")


g <- ggplot(data = survey_final_gis, aes(x = vechval, y = as.factor(any_adaptation)))
g + geom_boxplot() + labs(title = "Boxplot of Vehicle Value grouped by any_adaptation") +
  ylab("any_adaptation")
```
Boxplot of 
```{r}
milkcinc <- data.frame(survey_final_gis_clean$milkincwet,survey_final_gis_clean$milkincdry)
boxplot(milkcinc)
```
```{r}
SPI <- data.frame(survey_final_gis_clean$SPI_wet,survey_final_gis_clean$SPI_dry)
boxplot(SPI)
```
```{r}
rainfall <- data.frame(survey_final_gis_clean$rainfall_wet,survey_final_gis_clean$rainfall_dry)
boxplot(rainfall)
```


# Statisitcal analysis
## t test for drainage area

```{r}
quartiles_1 <- quantile(survey_final_gis[survey_final_gis$any_adaptation==1,]$drainage_area_km, probs=c(.25, .75), na.rm = TRUE)
IQR_1 <- IQR(survey_final_gis[survey_final_gis$any_adaptation==1,]$drainage_area_km,na.rm = TRUE)
 
Lower_1 <- quartiles_1[1] - 1.5*IQR_1
Upper_1 <- quartiles_1[2] + 1.5*IQR_1
 
data_no_outlier_1<- subset(survey_final_gis[survey_final_gis$any_adaptation==1,]$drainage_area_km, survey_final_gis[survey_final_gis$any_adaptation==1,]$drainage_area_km> Lower_1 & survey_final_gis[survey_final_gis$any_adaptation==1,]$drainage_area_km< Upper_1)

quartiles_0 <- quantile(survey_final_gis[survey_final_gis$any_adaptation==0,]$drainage_area_km, probs=c(.25, .75), na.rm = TRUE)
IQR_0 <- IQR(survey_final_gis[survey_final_gis$any_adaptation==0,]$drainage_area_km,na.rm = TRUE)
 
Lower_0 <- quartiles_0[1] - 1.5*IQR_0
Upper_0 <- quartiles_0[2] + 1.5*IQR_0
 
data_no_outlier_0 <- subset(survey_final_gis[survey_final_gis$any_adaptation==0,]$drainage_area_km, survey_final_gis[survey_final_gis$any_adaptation==0,]$drainage_area_km> Lower_0 & survey_final_gis[survey_final_gis$any_adaptation==0,]$drainage_area_km< Upper_0)

t.test(data_no_outlier_1 , data_no_outlier_0 ,na.rm=TRUE,var.equal = FALSE)
```



## t test for rainfall 
```{r}
quartiles_1 <- quantile(survey_final_gis[survey_final_gis$any_adaptation==1,]$rainfall, probs=c(.25, .75), na.rm = TRUE)
IQR_1 <- IQR(survey_final_gis[survey_final_gis$any_adaptation==1,]$rainfall,na.rm = TRUE)
 
Lower_1 <- quartiles_1[1] - 1.5*IQR_1
Upper_1 <- quartiles_1[2] + 1.5*IQR_1
 
data_no_outlier_1<- subset(survey_final_gis[survey_final_gis$any_adaptation==1,]$rainfall, survey_final_gis[survey_final_gis$any_adaptation==1,]$rainfall> Lower_1 & survey_final_gis[survey_final_gis$any_adaptation==1,]$rainfall< Upper_1)

quartiles_0 <- quantile(survey_final_gis[survey_final_gis$any_adaptation==0,]$rainfall, probs=c(.25, .75), na.rm = TRUE)
IQR_0 <- IQR(survey_final_gis[survey_final_gis$any_adaptation==0,]$rainfall,na.rm = TRUE)
 
Lower_0 <- quartiles_0[1] - 1.5*IQR_0
Upper_0 <- quartiles_0[2] + 1.5*IQR_0
 
data_no_outlier_0 <- subset(survey_final_gis[survey_final_gis$any_adaptation==0,]$rainfall, survey_final_gis[survey_final_gis$any_adaptation==0,]$rainfall> Lower_0 & survey_final_gis[survey_final_gis$any_adaptation==0,]$rainfall< Upper_0)
 
t.test(data_no_outlier_1 , data_no_outlier_0 ,na.rm=TRUE,var.equal = FALSE)
```
## t test for milkincome at different seasons  
We would like to see if there is any difference of milkincome between dry and wet season. The null hypothesis is mean value of milkincome is the same for dry and wet season. H0: $\mu_{mlkinc,dry}=\mu_{mlkinc,wet)}$ vs Ha: $\mu_{mlkinc,dry} \ne \mu_{mlkinc,wet)}$  

```{r}
t.test(survey_final_gis_clean$milkincwet,survey_final_gis_clean$milkincdry,na.rm=TRUE,var.equal = FALSE)
```
As p is much less than 0.05, we are confident the mean value of milkincome of wetseason is significant higher than dry season.  

## t-test for rainfall at different seasons
```{r}
t.test(survey_final_gis_clean$rainfall_wet,survey_final_gis_clean$rainfall_dry,na.rm=TRUE,var.equal = FALSE)
```

## t-test for SPI at different seasons
We would like to see if there is any difference in SPI between dry and wet season. The null hypothesis is mean value of SPI is the same for dry and wet season. H0: $\mu_{SPI,dry}=\mu_{SPI,wet)}$ vs Ha: $\mu_{SPI,dry} \ne \mu_{SPI,wet)}$ 
```{r}
t.test(survey_final_gis_clean$SPI_wet,survey_final_gis_clean$SPI_dry,na.rm=TRUE,var.equal = FALSE)
```
Average SPI and average monthly SPI in the peak of wet  season is significantly higher than those of dry season.   

## Anova analysis
We hypothesize drainage area of three regions may be different. We propose null hypothesis is drainage area means of three regions are the same. The alternativae hypothesis is drainage area means of three regions are different.  

### effect of region on drainage_area_km
```{r}
survey_final_gis$studycode<- factor(survey_final_gis$region)
aov_drainage <- aov(drainage_area_km ~ region, data=survey_final_gis)

summary(aov_drainage)
TukeyHSD(aov_drainage, conf.level=.95)
```
As p-value of F test is extremely small, we are confident that the drainage means of three regions are different. We further compared drainage means of three regions and found region "Rolim de Moura" has the highest drainage area, OPO has the smallest.  

### effect of region on income from beef
We then wants to see if there is difference in income from beef at different regions.
```{r}
aov_incbeef <- aov(incbeef ~ region, data=survey_final_gis )
summary(aov_incbeef)
TukeyHSD(aov_incbeef, conf.level=.95)
```
As p value is larger than 0.05, we can not reject our hypothesis that the means of income from beef at different regions are the same.  


### effect of region on rainfall 

```{r}
aov_rainfall <- aov(rainfall~ region, data=survey_final_gis )
summary(aov_rainfall)
TukeyHSD(aov_rainfall, conf.level=.95)
```
As p-value for F test of AONVA is very small, rainfall in three regions is not the same. It can be seen the rainfall in region "Rolim de Moura" is less than that in the other two.  


### effect of region on wealth 
```{r}
aov_vechval <- aov(vechval~ region, data=survey_final_gis_clean)
summary(aov_vechval)
TukeyHSD(aov_vechval, conf.level=.95)

```
The family wealth is significant different in three regions. The wealth in region "3"Rolim de Moura" is the largest.  

### Effect of region on adapatation method
Will need to do this for each method, since methods can overlap

First - cattle management

```{r}
# Need to change studycode into a factor
survey_final_gis$studycode <- as.factor(survey_final_gis$studycode)
aov_cattle_management <- aov(cattle_management ~ studycode, data = survey_final_gis)
summary(aov_cattle_management)
```
Cattle management appears to be the same across all three regions based on the p-value

Next - water management
```{r}
aov_water_management <- aov(water_management ~ studycode, data = survey_final_gis)
summary(aov_water_management)
TukeyHSD(aov_water_management, conf.level=.95)
```
Based on the p-value, we know at least two regions are signficantly different
Using the results of Tukey's HSD, we can see that regions 1 and 2 (Ariquemes and OPO)
are significantly different when it comes to water management

Next - pasture management
```{r}
aov_pasture_management <- aov(pasture_management ~ studycode, data = survey_final_gis)
summary(aov_pasture_management)
TukeyHSD(aov_pasture_management, conf.level=.95)
```
From the result of the ANOVA, we can see there is a difference between at least one region.
Looking at the result of Tukey, we can see the difference is significant between regions 1 and 2, and regions 2 and 3

Next - forest conservation
```{r}
aov_forest_conservation <- aov(forest_conservation ~ studycode, data = survey_final_gis)
summary(aov_forest_conservation)
#TukeyHSD(aov_pasture_management, conf.level=.95)
```
There is not a significant difference amongst regions due to forest conservation

### Effect of wealth on number of adaptations
```{r}
survey_final_gis <- survey_final_gis %>% mutate(adaptation_count = cattle_management + pasture_management + water_management + forest_conservation)
aov_vechval_adaptation_count <- aov(vechval ~ adaptation_count, data = survey_final_gis)
summary(aov_vechval_adaptation_count)
```

```{r}
fit_lr <- lm(adaptation_count ~ vechval, data = survey_final_gis)
summary(fit_lr)
```


# Modelling

## Multiple Logistic Regression Model
First to create a few different MLRs to see what the relationship is between
adaptation methods and water availability.

### Model 1
In this model, I will select the largest amount of variables. The dependent variable will be the general adaptation variable. The independent variables will be:
  - Drainage area
  - Lot size (can't find in data - ask Mariana)
  - Soil type (100% missing - so maybe not)
  - Vehicle value
  - SPI - using the maximum in the year
  - Risk
  - Lot value

(This model did not converge)
  
  
### Model 2
Trying with only drainage area to see if there's a relationship since previous model did not converge
```{r}
fit_2 <- glm(any_adaptation ~ drainage_area_km, family = binomial,data = survey_final_gis)
summary(fit_2)
```
The drainage area is not a statistically significant parameter in this case. However, there are outliers in the data that might be affecting this. Let's investigate.

```{r}
plot(fit_2, which = 4)
```

Fitting the model without observation 206
```{r}
survey_final_gis_no <- survey_final_gis[-c(206),]
fit_3 <- glm(any_adaptation ~ drainage_area_km, family = binomial,data = survey_final_gis_no)
summary(fit_3)
```
```{r}
plot(fit_3, which = 4)
```
Now to check Log Reg assumptions
```{r}
probabilities <- predict(fit_3, type = "response")
# Select only numeric predictors
mydata <- survey_final_gis_no %>%
  dplyr::select_if(is.numeric) %>%
  select(drainage_area_km)
predictors <- colnames(mydata)
# Bind the logit and tidying the data for plot
mydata <- mydata %>%
  mutate(logit = log(probabilities/(1-probabilities))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)
```

```{r}
ggplot(mydata, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")
```


### Model 3 - Transforming Drainage Area
Let's look at the distribution of drainage area to see if we should transform it

```{r}
g <- ggplot(data = survey_final_gis_no, aes(x = log(drainage_area_km)))
g + geom_histogram() + labs(title = "Histogram of log(Drainage Area)")
```

Now to create the model:

```{r}
fit_transform <- glm(any_adaptation ~ log(drainage_area_km), family = binomial,data = survey_final_gis)
summary(fit_transform)
```

### Model 4
For this model, we will take Dr. Harris's suggestion of an indicator variable for
the large drainage area lots (I believe is what he meant)

First going to see the fit with outliers chopped off

```{r}
survey_final_gis_filtered <- survey_final_gis %>% filter(drainage_area_km < 500)
fit_4 <- glm(any_adaptation ~ drainage_area_km, data = survey_final_gis_filtered, family = binomial)
summary(fit_4)
```


### model 5

```{r}
 survey_final_gis2<- drop_na(survey_final_gis,SPI_year)
survey_final_gis2$rainfall2 <- scale(survey_final_gis2$rainfall,center=TRUE,scale=T)
survey_final_gis2$drainage_area_km2 <-  scale(survey_final_gis2$drainage_area_km,center=TRUE,scale=T)
fit_3 <- glm(any_adaptation ~ log (drainage_area_km) + log(rainfall), family = binomial,data = survey_final_gis2)
summary(fit_3)
```


Now look at individual adaptation variables
```{r}
fit_cattle <- glm(cattle_management ~ drainage_area_km, family = binomial,data = survey_final_gis)
summary(fit_cattle)

fit_cattle_log = glm(cattle_management ~ log(drainage_area_km), family = binomial,data = survey_final_gis)
summary(fit_cattle_log)
```
Saw significance when using log(drainage area)

Next lets look at pasture management
```{r}
fit_pasture <- glm(pasture_management ~ drainage_area_km, family = binomial,data = survey_final_gis)
summary(fit_pasture)

fit_pasture_log <- glm(pasture_management ~ log(drainage_area_km), family = binomial,data = survey_final_gis)
summary(fit_pasture_log)
```
Similar results, but with a super low p for log(drainage area)

Next lets look at forest conservation
```{r}
fit_forest <- glm(forest_conservation ~ drainage_area_km, family = binomial,data = survey_final_gis)
summary(fit_forest)

fit_forest_log <- glm(forest_conservation ~ log(drainage_area_km), family = binomial,data = survey_final_gis)
summary(fit_forest_log)
```

Log(drainage area) is highly significant again

Let's now look at water management
```{r}
fit_water <- glm(water_management ~ drainage_area_km, family = binomial,data = survey_final_gis)
summary(fit_water)

fit_water_log <- glm(water_management ~ log(drainage_area_km), family = binomial,data = survey_final_gis)
summary(fit_water_log)
```

Similar results again. Log(drainage area) is significant for each of the adaptation categories.

What happens if I filter by "have cattle" and look at cattle_management

```{r}
survey_havecattle <-survey_final_gis %>% filter(havecattle ==1)
fit_cattle_have <- glm(cattle_management ~ drainage_area_km, family = binomial,data = survey_havecattle)
summary(fit_cattle_have)

fit_cattle_have_log <- glm(cattle_management ~ log(drainage_area_km), family = binomial,data = survey_havecattle)
summary(fit_cattle_have_log)
```

Interesting, if we only include those that have cattle, the significance of the log(drainage area) disappears.

Let's see if anything similar happens when filtered by havecattle for any of the other adaptations
```{r}
fit_pasture_have_log <- glm(pasture_management ~ log(drainage_area_km), family = binomial,data = survey_havecattle)
summary(fit_pasture_have_log)

fit_forest_have_log <- glm(forest_conservation ~ log(drainage_area_km), family = binomial,data = survey_havecattle)
summary(fit_forest_have_log)

fit_water_have_log <- glm(water_management ~ log(drainage_area_km), family = binomial,data = survey_havecattle)
summary(fit_forest_have_log)
```

We still have a significant log(drainage area) for all of the other adaptation categories.

I'm curious about how many farms made multiple adaptations
```{r}
table(survey_final_gis$cattle_management, survey_final_gis$pasture_management)

table(survey_final_gis$cattle_management, survey_final_gis$forest_conservation)

table(survey_final_gis$cattle_management, survey_final_gis$water_management)

table(survey_final_gis$pasture_management, survey_final_gis$forest_conservation)

table(survey_final_gis$pasture_management, survey_final_gis$water_management)

table(survey_final_gis$forest_conservation, survey_final_gis$water_management)
```

It looks like the majority of farmers who adapted did more than one thing.


Let's also look at deforestation as a linear model
```{r}
fit_deforest <- lm(cleared_area ~ drainage_area_km, data = survey_final_gis)
summary(fit_deforest)

fit_deforest_log <- lm(cleared_area ~ log(drainage_area_km), data = survey_final_gis)
summary(fit_deforest_log)
```

We see significance for both the drainage area and the log(drainage area). Both had positive coefficients, which is confusing if my understanding of drainage_area and cleared_area are both correct.

Look at models with vehicle value and drainage area. Drainage area was not significant in any models, but log(drainage area) is for some.
```{r}
survey_final_gis_wealth <- survey_final_gis %>% filter(!is.na(survey_final_gis$vechval))
fit_wealth_ldrain_water <- glm(water_management~  vechval + log(drainage_area_km), family = binomial, data = survey_final_gis_wealth )
fit_wealth_ldrain_cattle  <- glm(cattle_management~  vechval + log(drainage_area_km) , family = binomial, data = survey_final_gis_wealth )
fit_wealth_ldrain_pasture  <- glm(pasture_management~  vechval + log(drainage_area_km), family = binomial, data = survey_final_gis_wealth )
fit_wealth_ldrain_forest <- glm(forest_conservation~  vechval + log(drainage_area_km), family = binomial, data = survey_final_gis_wealth )
#fit_wealth_drainn_any_adaptation <- glm(any_adaptation~  vechval + log(drainage_area_km), family = binomial, data = survey_final_gis_wealth )
summary(fit_wealth_ldrain_water)
summary(fit_wealth_ldrain_cattle)
summary(fit_wealth_ldrain_pasture)
summary(fit_wealth_ldrain_forest)
#summary(fit_wealth_drain_any_adaptation )
```
The model for any adaptation did not converge, but all of the others did. Vehicle value was still significant for all of the adaptation measures. Log(drainage area) was not significant for water or cattle management when vehicle value is included, but it is for pasture management and forest conservation. For forest conservation, drainage area has a much smaller p value than vehicle value.

Try using draianage area with the tail chopped off instead of log transform
```{r}
survey_final_gis_wealth_filtered <- survey_final_gis_wealth %>% filter(drainage_area_km < 500)
fit_wealth_drain_water <- glm(water_management~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_cattle  <- glm(cattle_management~  vechval + drainage_area_km , family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_pasture  <- glm(pasture_management~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_forest <- glm(forest_conservation~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
#fit_wealth_drainn_any_adaptation <- glm(any_adaptation~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
summary(fit_wealth_drain_water)
summary(fit_wealth_drain_cattle)
summary(fit_wealth_drain_pasture)
summary(fit_wealth_drain_forest) 
#summary(fit_wealth_drain_any_adaptation )

```

With the drainage area outliers removed, drainage area is significant for forest conservation but none of the others.  
```{r}
rainfall_group<- cut(survey_final_gis_wealth_filtered$rainfall , c(0,1950,2300), label=c("low","high"))
rainfall_group <-factor(rainfall_group)
survey_final_gis_wealth_filtered$studycode <-factor(survey_final_gis_wealth_filtered$studycode)
fit_wealth_drain_water <- glm(water_management~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_cattle  <- glm(cattle_management~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_pasture  <- glm(pasture_management~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
fit_wealth_drain_forest <- glm(forest_conservation~  vechval + log(drainage_area_km) + log(rainfall_year) + studycode, family = binomial, data = survey_final_gis_wealth_filtered )
#fit_wealth_drainn_any_adaptation <- glm(any_adaptation~  vechval + drainage_area_km, family = binomial, data = survey_final_gis_wealth_filtered )
summary(fit_wealth_drain_water)
summary(fit_wealth_drain_cattle)
summary(fit_wealth_drain_pasture)
summary(fit_wealth_drain_forest)
#summary(fit_wealth_drain_any_adaptation )
```

Since we've seen that wealth is so important for adaptation, but drainage area importance 
decreases for wealth, let's see if other water availability proxies are signficant for the
individual adaptations

```{r}
fit_cattle_full <- glm(cattle_management ~ SPImax_year + vechval, family = binomial,data = survey_final_gis)
summary(fit_cattle)
```

```{r}
fit_water_full <- glm(water_management ~ SPImax_year + vechval, family = binomial,data = survey_final_gis)
summary(fit_water_full)
```

```{r}
fit_pasture_full <- glm(pasture_management ~ rainfall+ vechval, family = binomial,data = survey_final_gis)
summary(fit_pasture_full)
```

```{r}
fit_forest_full <- glm(forest_conservation ~ SPImin_year + vechval, family = binomial,data = survey_final_gis)
summary(fit_forest_full)
```